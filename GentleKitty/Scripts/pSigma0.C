#include "DLM_Source.h"
#include "DLM_Potentials.h"
#include "DLM_CkModels.h"
#include "CATS.h"
#include "DLM_CkDecomposition.h"
#include "DLM_Fitters.h"
#include "TidyCats.h"
#include "CATSInputSigma0.h"
#include "TRandom3.h"
#include "TFile.h"
#include "TGraph.h"
#include "TStyle.h"
#include "TLegend.h"
#include "TF1.h"
#include "TCanvas.h"
#include <iostream>
#include "CATSLambdaParam.h"
#include "SidebandSigma.h"
#include "TMinuit.h"
#include "TMath.h"
#include "TPaveText.h"
#include "DreamPlot.h"
#include "TNtuple.h"

/// Number of parameters for the sideband fit
const int nSidebandPars = 6;

/// =====================================================================================
/// Fit for the sidebands
auto sidebandFit =
    [ ] (double *x, double *p) {
      return p[0] + p[1] * x[0] + p[2] * x[0] * x[0] + p[3] * x[0] * x[0] *x[0] + std::exp(p[4] + p[5] * x[0]);
    };

/// =====================================================================================
/// Function to cast the nice lambda from above to CATS...
double sidebandFitCATS(const double &Momentum, const double *SourcePar,
                       const double *PotPar) {
  double *x = new double[1];
  x[0] = Momentum;
  double *p = const_cast<double*>(PotPar);
  return sidebandFit(x, p);
}

/// =====================================================================================
void FitSigma0(const unsigned& NumIter, TString InputDir, TString appendix,
               TString ppFile, TString OutputDir, const bool& isExclusion,
               const float d0 = 35, const float f0inv = 35) {
  DreamPlot::SetStyle();
  bool fastPlot = (NumIter == 0) ? true : false;
  TRandom3 rangen(0);
  TidyCats* tidy = new TidyCats();  // for some reason we need this for the thing to compile

  TNtuple* ntResult =
      new TNtuple(
          "fitResult",
          "fitResult",
          "IterID:femtoFitIter:BLSlope:ppRadius:bl_a:bl_a_err:bl_b:bl_b_err:"
          "sb_p0:sb_p0_err:sb_p1:sb_p1_err:sb_p2:sb_p2_err:sb_p3:sb_p3_err:sb_p4:sb_p4_err:sb_p5:sb_p5_err:"
          "primaryContrib:fakeContrib:SBnormDown:SBnormUp:"
          "chi2NDFGlobal:pvalGlobal:chi2Local:ndf:chi2NDF:pval:nSigma");

  Float_t ntBuffer[32];
  int iterID = 0;
  bool useBaseline = true;

  TString graphfilename = TString::Format("%s/Param_pSigma0_%i.root",
                                          OutputDir.Data(), NumIter);
  auto param = new TFile(graphfilename, "RECREATE");

  /// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  /// CATS input
  TString CalibBaseDir = "~/cernbox/SystematicsAndCalib/ppRun2_MB/";
  CATSInputSigma0 *CATSinput = new CATSInputSigma0();
  CATSinput->SetCalibBaseDir(CalibBaseDir.Data());
  CATSinput->SetMomResFileName("run2_decay_matrices_old.root");
  CATSinput->ReadResFile();
  CATSinput->SetSigmaFileName("Sample6_MeV_compact.root");
  CATSinput->ReadSigmaFile();
  CATSinput->ReadSigma0CorrelationFile(InputDir.Data(), appendix.Data());
  CATSinput->ObtainCFs(10, 340, 440);
  TString dataHistName = "hCk_ReweightedpSigma0MeV_0";
  auto dataHist = CATSinput->GetCF("pSigma0", dataHistName.Data());
  if (!dataHist) {
    std::cerr << "ERROR pSigma0 fitter: p-Sigma0 histogram missing\n";
    return;
  }
  auto sidebandHistUp = CATSinput->GetCF("pSigmaSBUp",
                                         "hCk_ReweightedpSigmaSBUpMeV_0");
  auto sidebandHistLow = CATSinput->GetCF("pSigmaSBLow",
                                          "hCk_ReweightedpSigmaSBLowMeV_0");
  if (!sidebandHistLow || !sidebandHistUp) {
    std::cerr << "ERROR pSigma0 fitter: p-pSigmaSB histogram missing\n";
    return;
  }

  /// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  /// Set up the CATS ranges, lambda parameters, etc.
  const int binwidth = dataHist->GetBinWidth(1);
  const unsigned NumMomBins_pSigma = int(800 / binwidth);
  double kMin_pSigma = dataHist->GetBinCenter(1) - binwidth / 2.f;
  const double kMax_pSigma = kMin_pSigma + binwidth * NumMomBins_pSigma;

  std::cout << "kMin_pSigma: " << kMin_pSigma << std::endl;
  std::cout << "kMax_pSigma: " << kMax_pSigma << std::endl;
  std::cout << "Binwidth: " << binwidth << std::endl;
  std::cout << "NumMomBins_pSigma: " << NumMomBins_pSigma << std::endl;

  // pp radius systematic variations
  const double ppRadius = 1.36;
  const std::vector<double> sourceSize = { { ppRadius, ppRadius * 0.8, ppRadius
      * 1.2 } };

  // femto fit region systematic variations
  const std::vector<double> femtoFitRegionUp = { { 550, 500, 600 } };

  /// Lambda parameters
  const double protonPurity = 0.991213;
  const double protonPrimary = 0.874808;
  const double protonLambda = 0.0876342;

  // proton secondary contribution systematic variations
  const std::vector<double> protonSecondary = { { protonLambda
      / (1. - protonPrimary), protonLambda / (1. - protonPrimary) * 0.8,
      protonLambda / (1. - protonPrimary) * 1.2 } };
  std::vector<CATSLambdaParam> lambdaParams;

  const double sigmaPurity = 0.199;
  const double sigmaPrimary = 1.;
  const Particle sigma0(sigmaPurity, sigmaPrimary, { { 0 } });

  for (size_t lambdaIter = 0; lambdaIter < protonSecondary.size();
      ++lambdaIter) {
    const Particle proton(
        protonPurity,
        protonPrimary,
        { { (1. - protonPrimary) * protonSecondary[lambdaIter], (1.
            - protonPrimary) * (1 - protonSecondary[lambdaIter]) } });

    lambdaParams.push_back( { proton, sigma0 });
    lambdaParams[lambdaIter].PrintLambdaParams();
  }

  // sideband fit normalization range systematic variation
  const std::vector<double> sidebandNormDown = { { 340, 400, 460 } };
  const std::vector<double> sidebandNormUp = { { 440, 500, 560 } };

  /// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  /// Fit the sideband
  auto side = new SidebandSigma();
  side->SetRebin(10);
  side->SetSideBandFile(InputDir.Data(), appendix.Data());

  /// Prefit for the baseline
  auto Prefit = (TH1F*) dataHist->Clone(Form("%s_prefit", dataHist->GetName()));
  auto funct_0 = new TF1("myPol0", "pol0", 250, 750);
  Prefit->Fit(funct_0, "FSNRMQ");

  TF1* funct_1 = new TF1("myPol1", "pol1", 250, 750);
  Prefit->Fit(funct_1, "FSNRMQ");
  gMinuit->SetErrorDef(1);  // 1 corresponds to 1 sigma contour, 4 to 2 sigma
  auto grPrefitContour = (TGraph*) gMinuit->Contour(40, 0, 1);

  std::vector<double> prefit_a;
  prefit_a.emplace_back(funct_0->GetParameter(0));
  prefit_a.emplace_back(funct_1->GetParameter(0));
  prefit_a.emplace_back(
      TMath::MinElement(grPrefitContour->GetN(), grPrefitContour->GetX()));
  prefit_a.emplace_back(
      TMath::MaxElement(grPrefitContour->GetN(), grPrefitContour->GetX()));

  std::vector<double> prefit_b;
  prefit_b.emplace_back(0);
  prefit_b.emplace_back(funct_1->GetParameter(1));
  prefit_b.emplace_back(grPrefitContour->Eval(prefit_a[2]));
  prefit_b.emplace_back(grPrefitContour->Eval(prefit_a[3]));

  std::cout << "Result of the prefit to constrain the baseline\n";
  for (size_t i = 0; i < prefit_a.size(); ++i) {
    std::cout << i << " a: " << prefit_a[i] << " b: " << prefit_b[i] << "\n";
  }

  delete funct_0;
  delete funct_1;
  delete Prefit;

  if (NumIter != 0) {
    std::cout << "\n\nStarting the systematic variations\n";
    std::cout << "Number of variations of the fit region: "
              << femtoFitRegionUp.size() << "\n";
    std::cout << "Number of variations of the baseline:   " << prefit_a.size()
              << "\n";
    std::cout << "Number of variations of the source size : "
              << sourceSize.size() << "\n";
    std::cout << "Number of variations of the sideband normalization: "
              << sidebandNormDown.size() << "\n";
    std::cout << "Number of variations of the lambda param: "
              << protonSecondary.size() << "\n\n";
  }

  // Set up the model, fitter, etc.
  DLM_Ck* Ck_pSigma0;

  if (isExclusion) {
    Ck_pSigma0 = new DLM_Ck(1, 2, NumMomBins_pSigma, kMin_pSigma, kMax_pSigma,
                            Lednicky_Singlet_InvScatLen);
  } else {
    Ck_pSigma0 = new DLM_Ck(1, 0, NumMomBins_pSigma, kMin_pSigma, kMax_pSigma,
                            Lednicky_gauss_Sigma0);
  }

  /// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  /// "Systematic" variations

  // 1. Femto fit range
  for (size_t femtoFitIter = 0; femtoFitIter < femtoFitRegionUp.size();
      ++femtoFitIter) {

    // 2. Baseline treatment
    for (size_t blIter = 0; blIter < prefit_a.size(); ++blIter) {

      if (blIter == 0) {
        useBaseline = false;  //use baseline
      } else {
        useBaseline = true;  // no baseline
      }

      // 3. Sideband normalization
      for (size_t sbNormIter = 0; sbNormIter < sidebandNormDown.size();
          ++sbNormIter) {

        side->SetNormalizationRange(sidebandNormDown[sbNormIter],
                                    sidebandNormUp[sbNormIter]);

        side->SideBandCFs();
        auto SBmerge = side->GetSideBands(5);
        const int firstBin = SBmerge->GetBinCenter(1);
        auto sideband = new TF1("sideband", sidebandFit, firstBin, 650,
                                nSidebandPars);
        sideband->SetParameter(0, -1.5);
        sideband->SetParameter(1, 0.);
        sideband->SetParameter(2, 0);
        sideband->SetParameter(3, 0);
        sideband->SetParameter(4, 1);
        sideband->SetParameter(5, 0);
        SBmerge->Fit(sideband, "FSNRMQ");

        DLM_Ck* Ck_SideBand = new DLM_Ck(0, nSidebandPars, NumMomBins_pSigma,
                                         kMin_pSigma, kMax_pSigma,
                                         sidebandFitCATS);
        std::cout << "Result of the sideband fit\n";
        for (unsigned i = 0; i < sideband->GetNumberFreeParameters(); ++i) {
          std::cout << i << " " << sideband->GetParameter(i) << std::endl;
          Ck_SideBand->SetPotPar(i, sideband->GetParameter(i));
        }
        Ck_SideBand->Update();

        // 4. Source size
        for (size_t sizeIter = 0; sizeIter < sourceSize.size(); ++sizeIter) {

          // 5. Lambda parameters
          for (size_t lambdaIter = 0; lambdaIter < lambdaParams.size();
              ++lambdaIter) {

            std::cout << "\n\n_________________________\n";
            std::cout << "Processing iteration " << iterID << "\n\n";

            /// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
            /// Correlation function
            Ck_pSigma0->SetSourcePar(0, sourceSize[sizeIter]);
            Ck_pSigma0->Update();

            // TODO TO BE FIXED - MOMENTUM RESOLUTION MATRIX!
            DLM_CkDecomposition CkDec_pSigma0("pSigma0", 1, *Ck_pSigma0,
                                              CATSinput->GetSigmaFile(0));

            /// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

            DLM_CkDecomposition CkDec_SideBand("pSigma0SideBand", 0,
                                               *Ck_SideBand, nullptr);
            CkDec_pSigma0.AddContribution(
                0,
                lambdaParams[lambdaIter].GetLambdaParam(CATSLambdaParam::Fake),
                DLM_CkDecomposition::cFake, &CkDec_SideBand);
            CkDec_pSigma0.Update();

            /// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
            /// Fitter
            DLM_Fitter1* fitter = new DLM_Fitter1(1);
            fitter->SetSystem(0, *dataHist, 1, CkDec_pSigma0, kMin_pSigma,
                              femtoFitRegionUp[femtoFitIter], 1000, 1000);
            fitter->SetSeparateBL(0, false);              //Simultaneous BL
            fitter->FixParameter("pSigma0", DLM_Fitter1::p_a, prefit_a[blIter]);
            fitter->FixParameter("pSigma0", DLM_Fitter1::p_b, prefit_b[blIter]);
            fitter->AddSameSource("pSigma0SideBand", "pSigma0", 1);

            //Fit BL & Normalization
            fitter->FixParameter("pSigma0", DLM_Fitter1::p_c, 0);
            fitter->FixParameter("pSigma0", DLM_Fitter1::p_Cl, -1.);
            fitter->FixParameter("pSigma0", DLM_Fitter1::p_sor0,
                                 sourceSize[sizeIter]);

            if (isExclusion) {
              fitter->FixParameter("pSigma0", DLM_Fitter1::p_pot0, f0inv);
              fitter->FixParameter("pSigma0", DLM_Fitter1::p_pot1, d0);
            }

            fitter->GoBabyGo();

            /// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
            /// Get the parameters from the fit
            const double bl_a = fitter->GetParameter("pSigma0",
                                                     DLM_Fitter1::p_a);
            const double bl_a_err = fitter->GetParError("pSigma0",
                                                        DLM_Fitter1::p_a);
            const double bl_b = fitter->GetParameter("pSigma0",
                                                     DLM_Fitter1::p_b);
            const double bl_b_err = fitter->GetParError("pSigma0",
                                                        DLM_Fitter1::p_b);
            const double Cl = fitter->GetParameter("pSigma0", DLM_Fitter1::p_c);
            const double chi2 = fitter->GetChi2Ndf();
            const double pval = fitter->GetPval();

            TGraph FitResult_pSigma0;
            FitResult_pSigma0.SetName(TString::Format("pSigma0Graph"));
            fitter->GetFitGraph(0, FitResult_pSigma0);

            double Chi2_pSigma0 = 0;
            double EffNumBins_pSigma0 = 0;
            int maxkStarBin = dataHist->FindBin(250);
            for (unsigned uBin = 1; uBin <= maxkStarBin; uBin++) {

              double mom = dataHist->GetBinCenter(uBin);
              //double dataX;
              double dataY;
              double dataErr;
              double theoryX;
              double theoryY;

              if (mom > femtoFitRegionUp[femtoFitIter]) {
                continue;
              }

              FitResult_pSigma0.GetPoint(uBin - 1, theoryX, theoryY);
              if (mom != theoryX) {
                std::cerr << "PROBLEM Sigma0 " << mom << '\t' << theoryX
                          << std::endl;
              }
              dataY = dataHist->GetBinContent(uBin);
              dataErr = dataHist->GetBinError(uBin);
              Chi2_pSigma0 += (dataY - theoryY) * (dataY - theoryY)
                  / (dataErr * dataErr);
              ++EffNumBins_pSigma0;
            }
            double pvalpSigma0 = TMath::Prob(Chi2_pSigma0,
                                             round(EffNumBins_pSigma0));
            double nSigmapSigma0 = TMath::Sqrt(2)
                * TMath::ErfcInverse(pvalpSigma0);

            std::cout << "=============\n";
            std::cout << "Fitter output\n";
            std::cout << "BL a  " << bl_a << " " << bl_a_err << "\n";
            std::cout << "BL b  " << bl_b << " " << bl_b_err << "\n";
            std::cout << "Cl    " << Cl << "\n";
            std::cout << "Chi2\n";
            std::cout << " glob " << chi2 << "\n";
            std::cout << " loc  " << Chi2_pSigma0 / round(EffNumBins_pSigma0)
                      << "\n";
            std::cout << "p-val\n";
            std::cout << " glob " << pval << "\n";
            std::cout << " loc  " << pvalpSigma0 << "\n";
            std::cout << "=============\n";

            /// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
            /// Write out all the stuff

            TGraph grCFSigmaRaw;
            grCFSigmaRaw.SetName("Sigma0Raw");
            TGraph grCFSigmaMain;
            grCFSigmaMain.SetName("Sigma0Main");
            TGraph grCFSigmaFeed;
            grCFSigmaFeed.SetName("Sigma0Feed");
            TGraph grCFSigmaSideband;
            grCFSigmaSideband.SetName("Sigma0Sideband");

            for (unsigned int i = 0; i < Ck_pSigma0->GetNbins(); ++i) {
              grCFSigmaRaw.SetPoint(
                  i, Ck_pSigma0->GetBinCenter(i),
                  CkDec_pSigma0.EvalCk(Ck_pSigma0->GetBinCenter(i)));
              grCFSigmaMain.SetPoint(
                  i,
                  Ck_pSigma0->GetBinCenter(i),
                  ((CkDec_pSigma0.EvalMain(Ck_pSigma0->GetBinCenter(i)) - 1.)
                      * lambdaParams[lambdaIter].GetLambdaParam(
                          CATSLambdaParam::Primary)) + 1);
              grCFSigmaFeed.SetPoint(
                  i, Ck_pSigma0->GetBinCenter(i),
                  CkDec_pSigma0.EvalMainFeed(Ck_pSigma0->GetBinCenter(i)));
              grCFSigmaSideband.SetPoint(
                  i,
                  Ck_pSigma0->GetBinCenter(i),
                  ((Ck_SideBand->Eval(Ck_pSigma0->GetBinCenter(i)) - 1.)
                      * lambdaParams[lambdaIter].GetLambdaParam(
                          CATSLambdaParam::Fake)) + 1);
            }

            TString outfilename = TString::Format("%s/Graph_pSigma0_%i_%i.root",
                                                  OutputDir.Data(), NumIter,
                                                  iterID);
            auto out = new TFile(outfilename, "RECREATE");

            /// beautification
            DreamPlot::SetStyleHisto(dataHist, 24, kBlack);
            dataHist->SetTitle(";#it{k}* (MeV/#it{c}); C(#it{k}*)");
            DreamPlot::SetStyleHisto(SBmerge, 20, kRed + 2);
            SBmerge->SetTitle(";#it{k}* (MeV/#it{c}); C_{sideband}(#it{k}*)");
            DreamPlot::SetStyleHisto(sidebandHistLow, 26, kGreen + 2);
            sidebandHistLow->SetTitle(
                ";#it{k}* (MeV/#it{c}); C_{sideband, low}(#it{k}*)");
            DreamPlot::SetStyleHisto(sidebandHistUp, 26, kCyan + 2);
            sidebandHistUp->SetTitle(
                ";#it{k}* (MeV/#it{c}); C_{sideband, up}(#it{k}*)");
            sideband->SetLineWidth(2);
            sideband->SetLineStyle(2);
            sideband->SetLineColor(kGray + 1);
            FitResult_pSigma0.SetLineWidth(2);
            FitResult_pSigma0.SetLineColor(kRed + 2);
            grCFSigmaSideband.SetLineWidth(2);
            grCFSigmaSideband.SetLineStyle(2);
            grCFSigmaSideband.SetLineColor(kGray + 1);

            grPrefitContour->Write("fitContour");
            grCFSigmaRaw.Write();
            grCFSigmaMain.Write();
            grCFSigmaFeed.Write();
            grCFSigmaSideband.Write();
            sidebandHistLow->Write("SidebandLow");
            sidebandHistUp->Write("SidebandUp");
            sideband->Write("SidebandFitNotScaled");
            SBmerge->Write("SidebandMerged");
            dataHist->Write("CF");
            FitResult_pSigma0.Write("Fit");

            if (fastPlot || iterID == 0) {
              auto c = new TCanvas();
              dataHist->GetXaxis()->SetRangeUser(0., 600);
              dataHist->GetYaxis()->SetRangeUser(0.8, 1.6);
              dataHist->Draw();
              FitResult_pSigma0.Draw("l3same");
              grCFSigmaSideband.Draw("l3same");

              auto info = new TPaveText(0.5, useBaseline ? 0.505 : 0.58, 0.88,
                                        0.85, "blNDC");
              info->SetBorderSize(0);
              info->SetTextSize(0.04);
              info->SetFillColor(kWhite);
              info->SetTextFont(42);
              TString SOURCE_NAME = "Gauss";
              double Yoffset = 1.2;
              info->AddText(
                  TString::Format(
                      "#it{r}_{%s} = %.3f #pm %.3f fm", SOURCE_NAME.Data(),
                      fitter->GetParameter("pSigma0", DLM_Fitter1::p_sor0),
                      fitter->GetParError("pSigma0", DLM_Fitter1::p_sor0)));
              info->AddText(
                  TString::Format("#it{a} = %.3f #pm %.3f", bl_a, bl_a_err));

              if (useBaseline) {
                info->AddText(
                    TString::Format("#it{b} = (%.3f #pm %.3f ) #times 10^{-4}",
                                    bl_b * 1e4, bl_b_err * 1e4));
              }
              info->AddText(
                  TString::Format("#chi_{loc}^{2}/ndf=%.1f/%.0f = %.2f",
                                  Chi2_pSigma0, EffNumBins_pSigma0,
                                  Chi2_pSigma0 / double(EffNumBins_pSigma0)));
              info->AddText(
                  TString::Format("#it{p}_{val}=%.3f, n_{#sigma}=%.3f",
                                  pvalpSigma0, nSigmapSigma0));

              info->Draw("same");
              c->Write("CFplot");
              c->Print(Form("%s/CF_pSigma0.pdf", OutputDir.Data()));

              auto d = new TCanvas();
              SBmerge->GetXaxis()->SetRangeUser(0., 600);
              SBmerge->GetYaxis()->SetRangeUser(0.8, 1.6);
              SBmerge->Draw();
              sideband->Draw("l3same");
              d->Write("CFsideband");
              d->Print(Form("%s/CF_pSideband.pdf", OutputDir.Data()));

              auto e = new TCanvas();
              SBmerge->Draw();
              sideband->Draw("l3same");
              sidebandHistLow->Draw("same");
              sidebandHistUp->Draw("same");
              auto leg = new TLegend(0.5, 0.6, 0.88, 0.85);
              leg->SetTextFont(42);
              leg->SetTextSize(0.05);
              leg->AddEntry(sidebandHistLow, "Sideband low", "pe");
              leg->AddEntry(sidebandHistUp, "Sideband up", "pe");
              leg->AddEntry(SBmerge, "Sideband merged", "pe");
              leg->AddEntry(sideband, "Fit", "l");
              leg->Draw("same");
              e->Write("CFsideband");
              e->Print(Form("%s/CF_pSideband_all.pdf", OutputDir.Data()));
            }
            out->Close();

            param->cd();
            ntBuffer[0] = iterID;
            ntBuffer[1] = femtoFitRegionUp[femtoFitIter];
            ntBuffer[2] = (float) blIter;
            ntBuffer[3] = sourceSize[sizeIter];
            ntBuffer[4] = bl_a;
            ntBuffer[5] = bl_a_err;
            ntBuffer[6] = bl_b;
            ntBuffer[7] = bl_b_err;
            ntBuffer[8] = sideband->GetParameter(0);
            ntBuffer[9] = sideband->GetParError(0);
            ntBuffer[10] = sideband->GetParameter(1);
            ntBuffer[11] = sideband->GetParError(1);
            ntBuffer[12] = sideband->GetParameter(2);
            ntBuffer[13] = sideband->GetParError(2);
            ntBuffer[14] = sideband->GetParameter(3);
            ntBuffer[15] = sideband->GetParError(3);
            ntBuffer[16] = sideband->GetParameter(4);
            ntBuffer[17] = sideband->GetParError(4);
            ntBuffer[18] = sideband->GetParameter(5);
            ntBuffer[19] = sideband->GetParError(5);
            ntBuffer[20] = lambdaParams[lambdaIter].GetLambdaParam(
                CATSLambdaParam::Primary);
            ntBuffer[21] = lambdaParams[lambdaIter].GetLambdaParam(
                CATSLambdaParam::Fake);
            ntBuffer[22] = sidebandNormDown[sbNormIter];
            ntBuffer[23] = sidebandNormUp[sbNormIter];
            ntBuffer[24] = chi2;
            ntBuffer[25] = pval;
            ntBuffer[26] = Chi2_pSigma0;
            ntBuffer[27] = (float) EffNumBins_pSigma0;
            ntBuffer[28] = Chi2_pSigma0 / double(EffNumBins_pSigma0);
            ntBuffer[29] = pvalpSigma0;
            ntBuffer[30] = nSigmapSigma0;

            ntResult->Fill(ntBuffer);
            ++iterID;

            delete out;
            delete fitter;

            if (NumIter == 0) {
              std::cout << "Skipping all systematic variations \n";
              goto exitThroughTheGiftShop;
            }
          }
        }
        delete sideband;
        delete Ck_SideBand;
      }
    }
  }
  exitThroughTheGiftShop:

  ntResult->Write();
  param->Close();
  return;
}

/// =====================================================================================
int main(int argc, char *argv[]) {
  FitSigma0(atoi(argv[1]), argv[2], argv[3], argv[4], argv[5], atoi(argv[6]),
            atof(argv[7]), atof(argv[8]));
  return 0;
}
